// Firebase Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users Collection
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if request.auth.uid == userId || isAdmin();
      allow create: if isValidUser(request.resource.data);
      allow update: if isValidUserUpdate(request.resource.data);
      allow delete: if isAdmin();
    }

    // Articles Collection
    match /articles/{articleId} {
      allow read: if request.auth != null || isPublished(resource.data);
      allow create: if isEditor() || isAdmin();
      allow update: if isAuthor(resource.data) || isEditor() || isAdmin();
      allow delete: if isEditor() || isAdmin();
    }

    // Projects Collection
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && isValidProject(request.resource.data);
      allow update: if isAuthor(resource.data) || isAdmin();
      allow delete: if isAuthor(resource.data) || isAdmin();
    }

    // Comments Collection
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && isValidComment(request.resource.data);
      allow update: if isAuthor(resource.data) || isEditor() || isAdmin();
      allow delete: if isAuthor(resource.data) || isEditor() || isAdmin();
    }

    // Audit Logs Collection
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Helper Functions
    function isAdmin() {
      return getRole() == 'admin';
    }

    function isEditor() {
      return getRole() == 'editor' || getRole() == 'admin';
    }

    function isUser() {
      return getRole() == 'user';
    }

    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAuthor(data) {
      return request.auth.uid == data.author.uid || request.auth.uid == data.userId;
    }

    function isPublished(data) {
      return data.status == 'published';
    }

    function isValidUser(data) {
      return data.size() > 0 && 'email' in data && 'name' in data && 'role' in data;
    }

    function isValidUserUpdate(data) {
      return !('role' in data) || isAdmin();
    }

    function isValidProject(data) {
      return data.size() > 0 && 'title' in data && 'description' in data;
    }

    function isValidComment(data) {
      return data.size() > 0 && 'content' in data && 'author' in data;
    }
  }
}
